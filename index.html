<!DOCTYPE html>
<html lang="en">
<head>
	<title>Tool for Diversity Visualization on the Level of Chemical Scaffolds</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<!-- T H E M E   C S S and F O N T and I C O N S-->
	<!-- <link type="text/css" rel="stylesheet" href="css/basic_theme.css"/> -->
	<link href="fonts/Roboto-Regular.ttf" rel="stylesheet">
	<link href="fonts/RobotoMono-Regular.ttf" rel="stylesheet">
	<!-- CSS -->
	<link type="text/css" rel="stylesheet" href="css/materialize_v1.css" media="screen,projection"/>
	<link type="text/css" rel="stylesheet" href="css/addition.css"/>
</head>
<body>
	<!-- N A V I G A T I O N -->
	<header class="pb-6">
	<nav class = "blue lighten-4">
		<div class="nav-wrapper">
			<a href="https://www.way2drug.com/tdv/" <span class="logo_svg"><img style="height: 95%; width: auto; vertical-align: middle;" src="img/logo_tdv.svg"></span></a>
			<ul id="nav-mobile" class="right hide-on-med-and-down">
				<li><a class="modal-trigger" href="#modal_about">About</a></li>
				<li><a class="modal-trigger" href="#modal_interpretation">Interpretation</a></li>
				<li><a class="modal-trigger" href="#modal_contacts">Contacts</a></li>
			</ul>
		</div>
	</nav>
	</header>
	<!-- W O R K I N G   S P A C E -->
	<main class="pt-6 valign-wrapper">
	<!-- CONTAINER TO HOLD OUTPUT interface -->
	<div class="container" id="main_container_outputInterface" hidden>
		<div class="row">
			<div id="svg_container_interface" class="section">
				<svg id = "svg_field_interface" viewBox="0 0 1600 1000" width = "100%" height = "62.5%"></svg>
			</div>
		</div>
		<div class="row">
			<div id="contBtns" class="center-align">
      	<button type="button" class="btn grey darken-1" id="interface_selectAll" >select all scaffolds</button>
      	<button type="button" class="btn grey darken-1" id="interface_deselectAll">deselect all scaffolds</button>
    	</div>
    </div>
    <div class="row">
    	
		</div>
		<div class="row">
			<div id="contFilter_num" class="right-align">
    		<div class="col s12">
          Filter by property value:
          <div class="input-field inline">
          	<input id="filter_property" type="text">
          	<label id="filter_property_label" for="filter_property">e.g.   < 80.536 & > 20.342</label>
          </div>
        </div>
      </div>
			<table id="table_data" class="display wrap" style="width:100%">
				<thead>
          <tr>
            <th>Scaffold ID</th>
            <th>N of structures         <a id="sort_structures_asc" href="#">&uharl;</a>    <a id="sort_structures_desc" href="#">&dharr;</a></th>
            <th>Scaffold SMILES</th>
            <th>Property        <a id="sort_mean_property_asc" href="#">&uharl;</a>    <a id="sort_mean_property_desc" href="#">&dharr;</a></th>
          </tr>
        </thead>
        <tbody id="table_data_body">
        </tbody>
			</table>
		</div>
	</div>
	<!-- CONTAINER TO HOLD INPUT and OUTPUT diversity  -->
	<div class="container" id="main_container_input_outputDiversity">
		<div id="progress_bar" class="section" hidden>
			<div class="row">
				<div class="progress blue lighten-5">
      		<div class="indeterminate blue lighten-4" style="width: 70%"></div>
  			</div>
  		</div>
  	</div>
  	<div id="svg_container" class="section" hidden>
			<div id="cloud_row" class="row">
				<div class = "s10">
					<svg id = "svg_field" viewBox="0 0 700 400" width = "100%" height = "58%"></svg>
				</div>
			</div>
			<div id="chart_row" class="row">
				<div class = "s10">
					<svg id = "chart_field" viewBox="0 0 700 400" width = "100%" height = "58%"></svg>
				</div>
			</div>
			<div id="description_row" class="row">
				<div id="description_div">
				</div>
				<a id="download_figure_btn" class="btn grey darken-1">download figure</a>
			</div>
		</div>			
		<div id="input_one" class="section">
			<div class="row">
				<div class = "s12">
					<form action = "#" id = "form_file">
						<div class="section"></div>
						<!-- select scaffold type -->
						<div class="row">
							<div class="col s12 m3">
								<div class="switch left-align">
									<!--#red need to select the particular span in CSS when the input is checked -->
    							<label>
      							<span id="non_generic_ttip" class="span_selected" data-position="top">non-generic</span>
      							<input id = "scaffold_checkbox" type="checkbox">
      							<span class="lever"></span>
      							<span id="generic_ttip" class="span_notSelected" data-position="top">generic</span>
    							</label>
								</div>
							</div>
							<div class="section" ></div>
						</div>
						<!-- Select upper bound for the range -->
						<div class="row">
							<div class="col s12 m3">
								<select id = "max_range">
									<option value='' disabled selected>max range, 50 is by default</option>
									<option value='1'> 1   </option>
									<option value='10'> 10  </option>
									<option value='50'> 50  </option>
									<option value='100'> 100 </option>
									<option value='150'> 150 </option>
									<option value='200'> 200 </option>
								</select>
							</div>
							<div class="section" ></div>
						</div>
						<div id="switch_spacer_1" class="section"></div>
						<!-- File upload -->
						<div class="row">
							<div class="col s12 m12">
  							<div class="file-field input-field outlined s12 m12">
  								<div class="btn grey darken-1">
      							<span>file:</span>
      							<input id="chem_file" type="file">
    							</div>
    							<div class="file-path-wrapper">
      							<input id="chem_file_wrapper" class="file-path validate left-align truncate" type="text" placeholder="Drag your file with chemical structures here, please.">
    							</div>
  							</div>
  						</div>
  					</div>
					</form>
				</div>
			</div>
		</div>
		<div id="input_two" class = "section center-align">
			<div class="row">
				<div class = "s12">
					<a id="diversity_btn" type="submit" form="form_file" class="btn grey darken-1">assess chemical diversity</a>
					<a id="property_num_btn" type="submit" form="form_file" class="btn grey darken-1">access property, numeric</a>
					<a id="property_str_btn" type="submit" form="form_file" class="btn grey lighten-1">access property, text</a>
				</div>
			</div>
		</div>
		<div id="bottom_section" class="section"></div>
		<div id="test" class="section center-align">
			<div class="row">
				<div>
					<span style="color:red;">T E S T: upload the file containing chemical structures (SDF, or TAB/CSV containing IDs in the 1st column and SMILES in the 2nd column), process it in browser, wait for the response from the server, wait for the cloud to appear. After that the page could be safely reloaded.</span>
				</div>
			</div>
		</div>
	<!-- M O D A L S -->
	<div id="modal_about" class="modal modal-fixed-footer">
		<div class="modal-content">
			<h4>Tool for Diversity Visualization on the Level of Chemical Scaffolds</h4>
				<p>. . .   A B O U T   . . .</p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close btn text">close</a>
		</div>
	</div>
	<div id="modal_interpretation" class="modal modal-fixed-footer">
		<div class="modal-content">
			<h4>Visualization of Scaffold Diversity</h4>
				<p>. . .   I N T E R P R E T A T I O N   . . .</p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close btn text">close</a>
		</div>
	</div>
	<div id="modal_contacts" class="modal modal-fixed-footer">
		<div class="modal-content">
			<h4>Contacts</h4>
				<p>Pavel V Pogodin, PhD</p>
				<p>pogodinpv@ibmc.msk.ru</p>
				<p>Subject of the letter should be <b>TDV</b></p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close btn text">close</a>
		</div>
	</div>
	</main>
	<!-- F O O T   N O T E S -->
	<footer>
		<div class="container">
			<div class="row">
				<div class="l12 s12">
					<p>The work is supported by the Russian Science Foundation, Project <a href="https://rscf.ru/en/project/23-73-01058/" target="_blank">23-73-01058</a></p>
					<p><a href="https://way2drug.com" target="_blank">Way2Drug</a> &#169 2011 - <script type="text/javascript">document.write(new Date().getFullYear());</script> | 
 						<a href="https://way2drug.com/prpol.php" target="_blank">Privacy Policy</a>
 					</p>
				</div>
			</div>
		</div>
	</footer>
</body>
</html>
<!-- S C R I P T S -->
<script type="text/javascript" src="js/materialize_v1_min.js"></script>
<script type="text/javascript" src="js/RDKit_min.js"></script>
<script type="text/javascript" src="js/papaparse.min.js"></script>
<script type="text/javascript" src="js/process_chemfile.js"></script>
<script type="text/javascript" src="js/distribute_svg.js"></script>
<script type="text/javascript" src="js/barchart.js"></script>
<script src="js/pic_table.js"></script>
<script>
  window
    .initRDKitModule({ locateFile: () => 'wasm/RDKit_min.wasm' })
    .then(function (RDKit) {
    	new M.Toast({html: `RDKit version:  ${RDKit.version()}`});
      window.RDKit = RDKit;
    })
    .catch(() => {
    	new M.Toast({html: "RDKit is not available, please reload the page or try again latter"});
      console.log("RDKit is not available, please reload the page or try again latter");
    });
	document.addEventListener('DOMContentLoaded', function() {
	//Modals
	const elems_modal = document.querySelectorAll('.modal');
	const modal_instances = M.Modal.init(elems_modal, {
  	// specify options here
	});
	//Checkbox
	const elem_checkbox = document.getElementById("scaffold_checkbox");
	const elem_span_gen = document.getElementById("generic_ttip");
	const elem_span_nongen = document.getElementById("non_generic_ttip");
	//Labels for scaffold and var to store the selected type
	let scaff_type = "non-generic";
	elem_checkbox.addEventListener('change', (event) => {
		if (event.currentTarget.checked) {
  		elem_span_nongen.className = "span_notSelected";
  		elem_span_gen.className = "span_selected";
  		scaff_type = "generic";
		} else {
  		elem_span_nongen.className = "span_selected";
  		elem_span_gen.className = "span_notSelected";
  		scaff_type = "non-generic";
		}
	});
	//Select
	const elem_select = document.getElementById("max_range");
	const select_instances = M.FormSelect.init(elem_select, {
		classes: "s12 m3"
	});
	selected_value = "50";
	elem_select.addEventListener('change', (event) => {
		selected_value = event.target.value;
	});
	//Tooltips for scaffolds
	//#red select examples, which are more illustrative
	const nonGen_ttip = document.getElementById("non_generic_ttip");
	const nonGen_ttip_instance = M.Tooltip.init(nonGen_ttip, {
		html: "<svg xmlns='https://www.w3.org/2000/svg' xml:space='preserve' id='nonGen_svg' viewBox='0 0 80 50'><defs><marker id='a' markerHeight='1' markerWidth='1' orient='auto-start-reverse' overflow='visible' preserveAspectRatio='xMidYMid' refX='0' refY='0' viewBox='0 0 1 1'><path fill='context-stroke' fill-rule='evenodd' d='m1 0-3 3h-2l3-3-3-3h2z'/></marker></defs><path fill='none' stroke='red' stroke-width='.53' d='M71.52 6.62v2.72' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M71.52 9.34v2.73' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='red' stroke-width='.53' d='M70.49 6.62v2.72' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M70.49 9.34v2.73' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='m71.02 11.77 5.95 3.47' class='bond-1 atom-1 atom-2'/><path fill='none' stroke='#000' stroke-width='.53' d='M76.97 15.24v6.9' class='bond-2 atom-2 atom-3'/><path fill='none' stroke='#000' stroke-width='.53' d='m76.97 22.15-6 3.44m4.97-4.05-4.95 2.86' class='bond-3 atom-3 atom-4'/><path fill='none' stroke='#000' stroke-width='.53' d='M70.96 25.59v6.9' class='bond-4 atom-4 atom-5'/><path fill='none' stroke='#000' stroke-width='.53' d='m70.96 32.5-5.98 3.43' class='bond-5 atom-5 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m64.98 35.93-.02 6.93m-1.03-6.32v5.71' class='bond-6 atom-6 atom-7'/><path fill='none' stroke='#000' stroke-width='.53' d='m64.96 42.86-5.98 3.44' class='bond-7 atom-7 atom-8'/><path fill='none' stroke='#000' stroke-width='.53' d='M58.98 46.3 53 42.84m5.98 2.25-4.95-2.86' class='bond-8 atom-8 atom-9'/><path fill='none' stroke='#000' stroke-width='.53' d='M53 42.84V35.9' class='bond-9 atom-9 atom-10'/><path fill='none' stroke='#000' stroke-width='.53' d='m53 35.9 2.33-1.32' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#00f' stroke-width='.53' d='m55.33 34.58 2.33-1.32' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#000' stroke-width='.53' d='m54.03 36.51 2.06-1.19' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#00f' stroke-width='.53' d='m56.1 35.32 2.06-1.19' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#000' stroke-width='.53' d='m70.96 25.59-5.95-3.47' class='bond-11 atom-4 atom-12'/><path fill='none' stroke='#000' stroke-width='.53' d='M65.01 22.12v-6.9m1.03 6.32v-5.72' class='bond-12 atom-12 atom-13'/><path fill='none' stroke='#000' stroke-width='.53' d='m65.01 15.21 6-3.44' class='bond-27 atom-13 atom-1'/><path fill='none' stroke='#00f' stroke-width='.53' d='m60.33 33.26 2.33 1.35' class='bond-30 atom-11 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m62.66 34.6 2.32 1.33' class='bond-30 atom-11 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m71.3 11.93-.28-.16-.32.16m5.98 3.13.29.18v.34m0 6.22v.35l-.3.18m-5.71 9.82v.34l-.29.19m-5.71 9.82v.36l-.3.16m-5.39 3.1-.3.18-.3-.18M53.29 43l-.3-.16v-.35m.01-6.21v-.38l.13-.05M65.3 22.3l-.29-.18v-.34m0-6.22v-.35l.3-.15'/><path fill='red' d='M69.67 4.87q0-.72.34-1.09.35-.4 1-.4.67 0 1.01.4.35.37.35 1.09 0 .71-.35 1.11-.37.42-1 .42-.64 0-1-.42-.35-.4-.35-1.11m1.35 1.19q.45 0 .68-.3.24-.3.24-.9 0-.57-.24-.86-.23-.3-.68-.3-.45 0-.7.3-.23.29-.23.87 0 .6.24.9.24.29.69.29' class='atom-0'/><path fill='#00f' d='m58.34 31.01.96 1.56q.1.13.26.42.16.27.16.3V31h.4v2.94h-.4l-1.03-1.7q-.14-.2-.27-.45-.13-.2-.16-.29v2.44h-.37V31h.45' class='atom-11'/><path fill='none' stroke='red' stroke-width='.53' d='M21.55 6.62v2.72' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M21.55 9.34v2.73' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='red' stroke-width='.53' d='M20.52 6.62v2.72' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M20.52 9.34v2.73' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M21.05 11.77 27 15.24' class='bond-1 atom-1 atom-2'/><path fill='none' stroke='#000' stroke-width='.53' d='M27 15.24v6.9' class='bond-2 atom-2 atom-3'/><path fill='none' stroke='#000' stroke-width='.53' d='m27 22.15-6 3.44m4.97-4.05-4.95 2.86' class='bond-3 atom-3 atom-4'/><path fill='none' stroke='#000' stroke-width='.53' d='M21 25.59v6.9' class='bond-4 atom-4 atom-5'/><path fill='none' stroke='#000' stroke-width='.53' d='m21 32.5-5.98 3.43m6-3.43L27 35.92' class='bond-5 atom-5 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m15.02 35.93-.03 6.93m-1.03-6.32v5.71' class='bond-6 atom-6 atom-7'/><path fill='none' stroke='#000' stroke-width='.53' d='M14.99 42.86 9 46.3' class='bond-7 atom-7 atom-8'/><path fill='none' stroke='#000' stroke-width='.53' d='m9.01 46.3-5.98-3.46m5.98 2.25-4.95-2.86' class='bond-8 atom-8 atom-9'/><path fill='none' stroke='#000' stroke-width='.53' d='M3.03 42.84V35.9' class='bond-9 atom-9 atom-10'/><path fill='none' stroke='#000' stroke-width='.53' d='m3.03 35.9 2.33-1.32' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#00f' stroke-width='.53' d='m5.36 34.58 2.33-1.32' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#000' stroke-width='.53' d='m4.06 36.51 2.07-1.19' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#00f' stroke-width='.53' d='m6.13 35.32 2.06-1.19' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#000' stroke-width='.53' d='m21 25.59-5.96-3.47' class='bond-11 atom-4 atom-12'/><path fill='none' stroke='#000' stroke-width='.53' d='M15.04 22.12v-6.9m1.03 6.32v-5.72' class='bond-12 atom-12 atom-13'/><path fill='none' stroke='#000' stroke-width='.53' d='m15.04 15.21 6-3.44' class='bond-27 atom-13 atom-1'/><path fill='none' stroke='#00f' stroke-width='.53' d='m10.36 33.26 2.33 1.35' class='bond-30 atom-11 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m12.69 34.6 2.33 1.33' class='bond-30 atom-11 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m21.34 11.93-.3-.16-.3.16m5.97 3.13.3.18v.34M27 21.8v.35l-.29.18M21 32.15v.34l-.3.19m-5.71 9.82v.36l-.3.16m-5.39 3.1-.29.18-.32-.18M3.32 43l-.29-.16v-.35m0-6.21v-.38l.13-.05M15.33 22.3l-.29-.18v-.34m0-6.22v-.35l.3-.15'/><path fill='red' d='M19.7 4.87q0-.72.34-1.09.35-.4 1-.4.67 0 1.01.4.35.37.35 1.09 0 .71-.35 1.11-.37.42-1 .42-.64 0-1-.42-.35-.4-.35-1.11m1.35 1.19q.45 0 .69-.3.23-.3.23-.9 0-.57-.23-.86-.24-.3-.7-.3-.44 0-.68.3-.24.29-.24.87 0 .6.24.9.24.29.69.29' class='atom-0'/><path fill='#00f' d='m8.37 31.01.96 1.56q.1.13.26.42.16.27.16.3V31h.4v2.94h-.4l-1.03-1.7-.27-.45q-.13-.2-.15-.29v2.44h-.38V31h.45' class='atom-11'/><path fill='none' stroke='#000' stroke-linejoin='round' stroke-miterlimit='40' stroke-width='.34' marker-end='url(#a)' d='M45.43 130.93h14.68' paint-order='fill markers stroke' transform='translate(-12.94 -101.89)'/></svg>"
	});
	const gen_ttip = document.getElementById("generic_ttip");
	const gen_ttip_instance = M.Tooltip.init(gen_ttip, {
		html: "<svg xmlns='https://www.w3.org/2000/svg' xml:space='preserve' id='gen_svg' viewBox='0 0 80 50'><defs><marker id='a' markerHeight='1' markerWidth='1' orient='auto-start-reverse' overflow='visible' preserveAspectRatio='xMidYMid' refX='0' refY='0' viewBox='0 0 1 1'><path fill='context-stroke' fill-rule='evenodd' d='m1 0-3 3h-2l3-3-3-3h2z'/></marker></defs><g fill='none' stroke='#000' stroke-width='.53'><path d='m71.02 11.77 5.95 3.47' class='bond-1 atom-1 atom-2'/><path d='M76.97 15.24v6.9' class='bond-2 atom-2 atom-3'/><path d='m76.97 22.15-6 3.44' class='bond-3 atom-3 atom-4'/><path d='M70.96 25.59v6.9' class='bond-4 atom-4 atom-5'/><path d='m70.96 32.5-5.98 3.43' class='bond-5 atom-5 atom-6'/><path d='m64.98 35.93-.02 6.93' class='bond-6 atom-6 atom-7'/><path d='m64.96 42.86-5.98 3.44' class='bond-7 atom-7 atom-8'/><path d='M58.98 46.3 53 42.84' class='bond-8 atom-8 atom-9'/><path d='M53 42.84V35.9' class='bond-9 atom-9 atom-10'/><path d='m70.96 25.59-5.95-3.47' class='bond-11 atom-4 atom-12'/><path d='M65.01 22.12v-6.9' class='bond-12 atom-12 atom-13'/><path d='m65.01 15.21 6-3.44' class='bond-27 atom-13 atom-1'/><path d='m71.3 11.93-.28-.16-.32.16m5.98 3.13.29.18v.34m0 6.22v.35l-.3.18m-5.71 9.82v.34l-.29.19m-5.71 9.82v.36l-.3.16m-5.39 3.1-.3.18-.3-.18'/><path d='m65 35.85-5.98-3.44' class='bond-7 atom-7 atom-8'/><path d='m59.02 32.41-5.97 3.47' class='bond-8 atom-8 atom-9'/><path d='m59.32 32.6-.3-.19-.31.19M53.29 43l-.3-.16v-.35m.01-6.21v-.38l.13-.05M65.3 22.3l-.29-.18v-.34m0-6.22v-.35l.3-.15'/></g><path fill='none' stroke='red' stroke-width='.53' d='M21.55 6.62v2.72' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M21.55 9.34v2.73' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='red' stroke-width='.53' d='M20.52 6.62v2.72' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M20.52 9.34v2.73' class='bond-0 atom-0 atom-1'/><path fill='none' stroke='#000' stroke-width='.53' d='M21.05 11.77 27 15.24' class='bond-1 atom-1 atom-2'/><path fill='none' stroke='#000' stroke-width='.53' d='M27 15.24v6.9' class='bond-2 atom-2 atom-3'/><path fill='none' stroke='#000' stroke-width='.53' d='m27 22.15-6 3.44m4.97-4.05-4.95 2.86' class='bond-3 atom-3 atom-4'/><path fill='none' stroke='#000' stroke-width='.53' d='M21 25.59v6.9' class='bond-4 atom-4 atom-5'/><path fill='none' stroke='#000' stroke-width='.53' d='m21 32.5-5.98 3.43m6-3.43L27 35.92' class='bond-5 atom-5 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m15.02 35.93-.03 6.93m-1.03-6.32v5.71' class='bond-6 atom-6 atom-7'/><path fill='none' stroke='#000' stroke-width='.53' d='M14.99 42.86 9 46.3' class='bond-7 atom-7 atom-8'/><path fill='none' stroke='#000' stroke-width='.53' d='m9.01 46.3-5.98-3.46m5.98 2.25-4.95-2.86' class='bond-8 atom-8 atom-9'/><path fill='none' stroke='#000' stroke-width='.53' d='M3.03 42.84V35.9' class='bond-9 atom-9 atom-10'/><path fill='none' stroke='#000' stroke-width='.53' d='m3.03 35.9 2.33-1.32' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#00f' stroke-width='.53' d='m5.36 34.58 2.33-1.32' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#000' stroke-width='.53' d='m4.06 36.51 2.07-1.19' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#00f' stroke-width='.53' d='m6.13 35.32 2.06-1.19' class='bond-10 atom-10 atom-11'/><path fill='none' stroke='#000' stroke-width='.53' d='m21 25.59-5.96-3.47' class='bond-11 atom-4 atom-12'/><path fill='none' stroke='#000' stroke-width='.53' d='M15.04 22.12v-6.9m1.03 6.32v-5.72' class='bond-12 atom-12 atom-13'/><path fill='none' stroke='#000' stroke-width='.53' d='m15.04 15.21 6-3.44' class='bond-27 atom-13 atom-1'/><path fill='none' stroke='#00f' stroke-width='.53' d='m10.36 33.26 2.33 1.35' class='bond-30 atom-11 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m12.69 34.6 2.33 1.33' class='bond-30 atom-11 atom-6'/><path fill='none' stroke='#000' stroke-width='.53' d='m21.34 11.93-.3-.16-.3.16m5.97 3.13.3.18v.34M27 21.8v.35l-.29.18M21 32.15v.34l-.3.19m-5.71 9.82v.36l-.3.16m-5.39 3.1-.29.18-.32-.18M3.32 43l-.29-.16v-.35m0-6.21v-.38l.13-.05M15.33 22.3l-.29-.18v-.34m0-6.22v-.35l.3-.15'/><path fill='red' d='M19.7 4.87q0-.72.34-1.09.35-.4 1-.4.67 0 1.01.4.35.37.35 1.09 0 .71-.35 1.11-.37.42-1 .42-.64 0-1-.42-.35-.4-.35-1.11m1.35 1.19q.45 0 .69-.3.23-.3.23-.9 0-.57-.23-.86-.24-.3-.7-.3-.44 0-.68.3-.24.29-.24.87 0 .6.24.9.24.29.69.29' class='atom-0'/><path fill='#00f' d='m8.37 31.01.96 1.56q.1.13.26.42.16.27.16.3V31h.4v2.94h-.4l-1.03-1.7-.27-.45q-.13-.2-.15-.29v2.44h-.38V31h.45' class='atom-11'/><path fill='none' stroke='#000' stroke-linejoin='round' stroke-miterlimit='40' stroke-width='.34' marker-end='url(#a)' d='M48.2 134.31h14.67' paint-order='fill markers stroke' transform='translate(-15.7 -105.27)'/></svg>"
	});
	//Define the GLOBAL input type
	global_input_type = 'smiles';
	//Load the data on CIs
	//Get deflated Cis form the server, SEE: https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
	const fetch_confidence = async function (url) {
		try {
    	const response = await fetch(url);
    	if (!response.ok) {
      	throw new Error(`Response status: ${response.status}`);
    	}
    	const json = await response.json();
    	return json;
    } catch (error) {
    	console.error(error.message);
  	}
	}
	//Some TABLE sortings
	const sort_structures_asc = async function() {
		console.log("SORT");
		property_map = new Map([...property_map.entries()].sort((a, b) => a[1]['n_structures'] - b[1]['n_structures']));
		await update_table(elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);
	}
	const sort_structures_desc = async function() {
		console.log("SORT");
		property_map = new Map([...property_map.entries()].sort((a, b) => b[1]['n_structures'] - a[1]['n_structures']));
		await update_table(elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);
	}
	const sort_mean_property_asc = async function() {
		console.log("SORT");
		property_map = new Map([...property_map.entries()].sort((a, b) => a[1]['mean_property'] - b[1]['mean_property']));
		await update_table(elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);
	}
	const sort_mean_property_desc = async function() {
		console.log("SORT");
		property_map = new Map([...property_map.entries()].sort((a, b) => b[1]['mean_property'] - a[1]['mean_property']));
		await update_table(elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);
	}
	//Assess and visualize chemical diversity on scaffold level OR access properties
	const file_supplier = document.getElementById("chem_file");
	const start_diversity = document.getElementById("diversity_btn");
	const start_property_num = document.getElementById("property_num_btn");
	const start_property_str = document.getElementById("property_str_btn");
	const container_main = document.getElementById("main_container_input_outputDiversity");
	const container_interface = document.getElementById("main_container_outputInterface");
	const svg_result = document.getElementById("svg_field");
	const svg_interface = document.getElementById("svg_field_interface");
	const description_field = document.getElementById("description_div");
	//Interface buttons
	const btn_select = document.getElementById("interface_selectAll");
	const btn_deselect = document.getElementById("interface_deselectAll");
	//Prepare the scaffold cloud
	start_diversity.onclick = async function () {
		progress_bar.hidden = false;
		let response_data = await process_chemFile(file_supplier, scaff_type, 1);
		//Prepare the data for visualization
		response_data = response_data['result'];
		progress_bar.hidden = true;
		svg_container.hidden = false;
		//Initialize the cloud's building
		things = response_data['data'];
		let number_things = things.length;
		//Set up the canvas
		const canvas = new OffscreenCanvas(200, 200);
		const context = canvas.getContext("2d", { willReadFrequently: true });
		const canvas_height = canvas.height;
		const canvas_width = canvas.width;
		context.fillStyle = "#000000";
		context.globalAlpha = 1;
		//SVGs
		const picture = svg_interface;
		//Set up the plane
		//Get the number of leaves
		const appr_n_leaves = Math.ceil(number_things / 3);
		//Get the approximate size
		const min_size = 32000;
		let initial_size = 200 * Math.round(appr_n_leaves * (canvas_width / 4) / 200);
		if (initial_size < min_size) {
			initial_size = min_size;
		}
		//Get the number of splits
		n_splits = Math.ceil(Math.log2(initial_size / 50));
		//Get the exact size
		initial_size = Math.pow(2, n_splits - 1) * (canvas_width / 4);
		//Calclulate the plane's dimensions
		const min_square_x = 0 - initial_size / 2;
		const min_square_y = min_square_x;
		const max_square_x = Math.abs(min_square_x);
		const max_square_y = max_square_x;
		
		//Create the plane
		plane_l0 = new Map();
		content_l0 = {'id': 0,
										'parent_id': 0,
										'x_min': min_square_x,
										'y_min': min_square_y,
										'x_max': max_square_x,
										'y_max': max_square_y,
										'area': 0,
										'n_things': 0,
										'children': []};
		plane_l0.set(content_l0.id, content_l0);
		//Create array to store the plane's split
		levels = [];
		//Split the plane
		levels = construct_split(plane_l0, n_splits, set_get_quads, initial_size, levels);
		//Start the placing
		stat = await placer(levels, svg_field, things, canvas, canvas_width, canvas_height, context, getIndex_nonzero);
		//#D8737F
		//Build the chart
		//Prepare for charting
		const chart = document.querySelector("#chart_field");
		//Place the chart
		await charter(chart, response_data, chart.width['baseVal']['value'], chart.height['baseVal']['value'], fetch_confidence);
		//#D8737F
		//Add description
		describe_results(description_field, response_data);
		//#D8737F
		//Resize SVGs
		let bbox_result = svg_result.getBBox();
		let bbox_chart = chart_field.getBBox();
		svg_field.setAttribute('viewBox', `${bbox_result.x - 10} ${bbox_result.y - 10} ${bbox_result.width + 10} ${bbox_result.height + 10}`);
		chart_field.setAttribute('viewBox', `${bbox_chart.x - 10} ${bbox_chart.y - 10} ${bbox_chart.width + 10} ${bbox_chart.height + 10}`);
		//Important to be here
		svg_text_pic = '<svg id = "description_field" viewBox="0 0 700 100" width = "700" height = "100"><text x="15" y="50">' + document.querySelector("#description_paragraph").innerHTML + '</text></svg>';
		//Enable each scaffold
		const depicted_scaffolds = document.getElementsByClassName("thing");
		for (let i = 0; i < depicted_scaffolds.length; i++) {
			let thing = depicted_scaffolds[i];
			thing.classList.add("enabled_thing");
		}
	};
	//Prepare the interface to access the numeric property
	start_property_num.onclick = async function () {
		//Get the element with the filtering criterion
		const filter_supplier = document.getElementById("filter_property");
		//Sorting
		//By the number of structures
		const elem_sort_structures_asc = document.getElementById("sort_structures_asc");
		elem_sort_structures_asc.onclick = await sort_structures_asc;
		const elem_sort_structures_desc = document.getElementById("sort_structures_desc");
		elem_sort_structures_desc.onclick = await sort_structures_desc;
		//By the mean value of properrty
		const elem_sort_mean_property_asc = document.getElementById("sort_mean_property_asc");
		elem_sort_mean_property_asc.onclick = await sort_mean_property_asc;
		const elem_sort_mean_property_desc = document.getElementById("sort_mean_property_desc");
		elem_sort_mean_property_desc.onclick = await sort_mean_property_desc;
		//Get the table
		elem_table = document.getElementById("table_data");
		elem_table_body = document.getElementById("table_data_body");
		//Prepare the structure to hold the properties and associated data
		property_map = new Map();
		//Structure of the property data:
		//{'scaff_id', 'global_input_type', 'n_structures', 'scaff_smiles', 'structures':[..., [id, initial_id, structure, initial_structure, property], ...], 'state', 'mean property' }
		//Restrict the max range
		selected_value = "20";
		//Basic preparations
		progress_bar.hidden = false;
		response_data = await process_chemFile(file_supplier, scaff_type, 2);
		//Get the data for table
		raw_property_data = response_data['data'];
		response_data = response_data['result']['data'];
		//Make copy for the visualization
		things = response_data;

		//Prepare the data for table
		//Provide the initial sorting, SEE for example: https://stackoverflow.com/questions/54623130/javascript-sort-an-array-of-objects-by-a-numeric-property-in-each-object
		response_data = response_data.sort(({structure_ids : a}, {structure_ids : b}) => b.length - a.length);
		//To MAP
		for (let i = 0; i < response_data.length; i++) {
			let i_scaff_id = response_data[i]['id'];
			let i_scaff_smiles = response_data[i]['scaff_smiles'];
			let i_n_structures = (response_data[i]['structure_ids']).length;
			let i_structures = [];
			let i_mean_val = 0;
			let i_matches = 0;
			let i_val = 0;
			//Prepare data for the table, Search properties for the associated structures
			for (let k = 0; k < raw_property_data.length; k++) {
				let k_structures;
				if(response_data[i]['structure_ids'].includes(raw_property_data[k][4])) {
					i_matches++;
					i_val = i_val + parseFloat(raw_property_data[k][2]);
					k_structures = [ raw_property_data[k][4], raw_property_data[k][0], raw_property_data[k][1], raw_property_data[k][3], raw_property_data[k][2] ];
					i_structures.push(k_structures);
				}
				//break if all structures are gathered
				if (i_matches == i_n_structures) break;
			}
			//Create property data to work with
			if (i_matches > 0) {
				let mean_val = Math.round(( (i_val / parseFloat(i_n_structures))  + Number.EPSILON) * 1000) / 1000;
				property_map.set(i_scaff_id, {'i_scaff_id':i_scaff_id, 'global_input_type':global_input_type, 'n_structures':i_n_structures, 'scaff_smiles':i_scaff_smiles, 'structures':i_structures, 'state':1, 'mean_property':mean_val });
			}
		}
		//Prepare the table
		await update_table(elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);

		//Make the results visible
		container_main.hidden = true;
		container_interface.hidden = false;

		//Initialize the cloud's building
		let number_things = things.length;
		//Set up the canvas
		const canvas = new OffscreenCanvas(200, 200);
		const context = canvas.getContext("2d", { willReadFrequently: true });
		const canvas_height = canvas.height;
		const canvas_width = canvas.width;
		context.fillStyle = "#000000";
		context.globalAlpha = 1;
		//SVGs
		const picture = svg_interface;
		//Set up the plane
		//Get the number of leaves
		const appr_n_leaves = Math.ceil(number_things / 3);
		//Get the approximate size
		const min_size = 32000;
		let initial_size = 200 * Math.round(appr_n_leaves * (canvas_width / 4) / 200);
		if (initial_size < min_size) {
			initial_size = min_size;
		}
		//Get the number of splits
		n_splits = Math.ceil(Math.log2(initial_size / 50));
		//Get the exact size
		initial_size = Math.pow(2, n_splits - 1) * (canvas_width / 4);
		//Calclulate the plane's dimensions
		const min_square_x = 0 - initial_size / 2;
		const min_square_y = min_square_x;
		const max_square_x = Math.abs(min_square_x);
		const max_square_y = max_square_x;		
		//Create the plane
		plane_l0 = new Map();
		content_l0 = {'id': 0,
										'parent_id': 0,
										'x_min': min_square_x,
										'y_min': min_square_y,
										'x_max': max_square_x,
										'y_max': max_square_y,
										'area': 0,
										'n_things': 0,
										'children': []};
		plane_l0.set(content_l0.id, content_l0);
		//Create array to store the plane's split
		levels = [];
		//Split the plane
		levels = construct_split(plane_l0, n_splits, set_get_quads, initial_size, levels);
		//Start the placing
		stat = await placer(levels, picture, things, canvas, canvas_width, canvas_height, context, getIndex_nonzero);
		//Resize the SVG interface
		let bbox_result = picture.getBBox();
		svg_field_interface.setAttribute('viewBox', `${bbox_result.x - 10} ${bbox_result.y - 10} ${bbox_result.width + 10} ${bbox_result.height + 10}`);
		//Enable each scaffold
		const depicted_scaffolds = document.getElementsByClassName("thing");
		for (let i = 0; i < depicted_scaffolds.length; i++) {
			let thing = depicted_scaffolds[i];
			thing.classList.add("enabled_thing");
		}

		//Provide the interactivity for the SVG interface
		//Click on scaffold
		for (let i = 0; i < depicted_scaffolds.length; i++) {
			let thing = depicted_scaffolds[i];
			thing.onclick = function() {
				if ( thing.classList.contains('enabled_thing') ) {
					thing.classList.remove('enabled_thing');
				} else {
					thing.classList.add('enabled_thing');
				}
			}
		}
		//Selection buttons
		btn_select.onclick = function() {
			for (let i = 0; i < depicted_scaffolds.length; i++) {
				let thing = depicted_scaffolds[i];
				if (thing.getAttribute('class') == 'thing') thing.classList.add('enabled_thing');
			}
		}
		btn_deselect.onclick = function() {
			for (let i = 0; i < depicted_scaffolds.length; i++) {
				let thing = depicted_scaffolds[i];
				thing.classList.remove('enabled_thing');
			}
		}

		//Add observer, https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver
		//Configure
		const pic_observer_config = { attributes: true, attributeOldValue: true, childList: true, subtree: true };
		//Pic Observer Callback
		const pic_observer_callback = async ( mutationList, observer ) => {
  		for (const mutation of mutationList) {
    		if ( (mutation.oldValue == "thing enabled_thing" && mutation.target.getAttribute('class') == "thing") || (mutation.oldValue == "thing" && mutation.target.getAttribute('class') == "thing enabled_thing") ) {
    			x = mutation;
    			//Update the property map
    			let property_update = property_map.get(mutation.target.id);
    			property_update['state'] = 1 - property_update['state'];
    			property_map.set(mutation.target.id, property_update);
    			//Update the table
    			await update_table(elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);
    		}
  		}
		}
		//Create observer instance
		const pic_observer = new MutationObserver(pic_observer_callback);
		//Start observations
		pic_observer.observe( picture, pic_observer_config );
		//Add event to the filtering input
		filter_supplier.addEventListener("keyup", async function(event) {
    	if (event.key === "Enter") {
      	// Process input
      	new M.Toast({html: `Table Filtering`});
      	await filter_property(filter_supplier, elem_table_body, property_map, ['i_scaff_id', 'n_structures', 'scaff_smiles', 'mean_property']);

    	}
		});

	}
	//Prepare the interface to access the text property
	start_property_str.onclick = async function (property_type, input_processor_opt, input_processor) {
		progress_bar.hidden = false;
		let response_data = await process_chemFile(file_supplier, scaff_type, 3);
		container_main.hidden = true;
		container_interface.hidden = false;
	}

	//Download Figure, SEE for example: https://codepen.io/patacra/pen/XWgqwRv
	//Also SEE for example: https://stackoverflow.com/questions/57798877/button-for-downloading-svg-in-javascript-html
	download_figure = document.getElementById("download_figure_btn");
	download_figure.onclick = async function () {
		let cloud_download = document.getElementById("svg_field");
		const cloud_download_bbox = cloud_download.getBBox();
		let scaling_factor = 700 / cloud_download_bbox['width'];
		const cloud_download_bbox_scaled = [ cloud_download_bbox['x']*scaling_factor,
																				 cloud_download_bbox['y']*scaling_factor,
																				 cloud_download_bbox['width']*scaling_factor,
																				 cloud_download_bbox['height']*scaling_factor ]
		let cloud_download_text = '<g id="cloud_pic" transform="matrix('+scaling_factor+', 0, 0, '+scaling_factor+', ' +-cloud_download_bbox_scaled[0]+ ', ' +-cloud_download_bbox_scaled[1]+ ')">' + cloud_download.innerHTML + '</g>';
		const cloud_download_height = cloud_download_bbox_scaled[3];
		let chart_download = document.getElementById("chart_field");
		const chart_download_bbox = chart_download.getBBox();
		scaling_factor = 700 / chart_download_bbox['width'];
		const chart_download_bbox_scaled = [ chart_download_bbox['x']*scaling_factor,
																				 chart_download_bbox['y']*scaling_factor,
																				 chart_download_bbox['width']*scaling_factor,
																				 chart_download_bbox['height']*scaling_factor ]
		let chart_download_text = '<g id="chart_pic" transform="matrix('+scaling_factor+', 0, 0, '+scaling_factor+', ' +-chart_download_bbox_scaled[0]+ ', ' +(cloud_download_height-chart_download_bbox_scaled[1])+ ')">' + chart_download.innerHTML + '</g>';
		const chart_download_height = chart_download_bbox_scaled[3];
		//Prepare the whole picture
		let figure_svg = new Blob(['<svg version="1.1" width="700" height="'+(cloud_download_height+chart_download_height+5)+'" xmlns="http://www.w3.org/2000/svg">\n' +cloud_download_text+ '\n' +chart_download_text+ '\n</svg>']);
		const download_element = document.createElement("a");
		download_element.download = "FIGURE_scaffold-diversity.svg";
		download_element.href = window.URL.createObjectURL(figure_svg);
		download_element.click();
		download_element.remove();
		new M.Toast({html: `Figure is downloading 																											`});
	}

});

</script>